---
- name: Setup new Ubuntu desktop machine
  hosts: local
  user: root
  connection: local

  vars:
      emacs_source_url: http://mirror.team-cymru.org/gnu/emacs/emacs-24.5.tar.gz

  tasks:

    - name: generate ssh keys
      user: name=ethan generate_ssh_key=yes ssh_key_bits=2048 ssh_key_file=.ssh/id_rsa

    - name: install apt packages
      apt: name={{ item }} state=present
      sudo: yes
      with_items:
          - git
          - terminator
          - tree
          - virtualbox-qt
          - ipython
          - editorconfig
          - xclip
          - silversearcher-ag
          - nautilus-dropbox
          - indicator-multiload
          - python-pip
          - python-psutil
          - python-rope
          - python-flake8
          - python-autopep8
          - virtualenv
          - virtualenvwrapper

    - name: install PyPi packages
      pip: name={{ item }} state=present
      with_items:
          - importmagic
          - pdbpp

    - name: make emacs source directory
      file:
          path: "{{ ansible_env.HOME }}/emacs-src"
          state: directory

    - name: download emacs source
      get_url:
          url: "{{ emacs_source_url }}"
          dest: "{{ ansible_env.HOME }}/emacs-src/emacs.tar.gz"
          mode: 0755

    - name: unzip emacs source
      unarchive:
          src: "{{ ansible_env.HOME }}/emacs-src/emacs.tar.gz"
          dest: "{{ ansible_env.HOME }}/emacs-src"

    - name: install dependencies
      apt:
          name: "build-essential"
          update_cache: yes
      sudo: yes

    - name: install emacs dependencies
      apt:
          name: emacs24
          update_cache: yes
          state: build-dep
      sudo: yes

    - name: configure emacs
      command: ./configure
      args:
          chdir: "{{ ansible_env.HOME }}/emacs-src/emacs-24.5/"

    - name: make emacs
      command: make
      args:
          chdir: "{{ ansible_env.HOME }}/emacs-src/emacs-24.5/"

    - name: make install emacs
      command: make install
      args:
          chdir: "{{ ansible_env.HOME }}/emacs-src/emacs-24.5/"
      sudo: yes

    - name: download .emacs.d
      git:
          repo: https://github.com/el-ethan/.emacs.d.git
          dest: "{{ ansible_env.HOME }}/.emacs.d"

    - name: download dot files
      git:
          repo: https://github.com/el-ethan/dotfiles.git
          dest: "{{ ansible_env.HOME }}/dotfiles"

    - name: download terminator theme
      git:
          repo: https://github.com/el-ethan/terminator.git
          dest: "{{ ansible_env.HOME }}/.config/terminator"

    - name: symlink config files
      file: src=/home/ethan/dotfiles/{{ item.src }} dest={{ item.dest }} state=link force=yes
      with_items:
          - { src: '.bashrc', dest: '{{ ansible_env.HOME }}/.bashrc'}
          - { src: '.pdbrc', dest: '{{ ansible_env.HOME }}/.pdbrc'}
          - { src: '.pdbrc.py', dest: '{{ ansible_env.HOME }}/.pdbrc.py'}

    - name: set swapiness to 10
      command: sysctl vm.swappiness=10
      sudo: yes

    - name: enable uncomplicated firewall
      command: ufw enable
      sudo: yes

    - name: add enpass to sources
      lineinfile:
          dest: /etc/apt/sources.list.d/enpass.list
          line: "deb http://repo.sinew.in/ stable main"
          create: yes
      sudo: yes

    - name: add key for enpass
      apt_key:
          url: http://repo.sinew.in/keys/enpass-linux.key
      sudo: yes

    - name: install enpass
      apt: name=enpass state=present update_cache=yes
      sudo: yes
